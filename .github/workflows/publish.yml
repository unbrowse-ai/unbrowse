name: Publish

on:
  workflow_dispatch:
    inputs:
      force_publish:
        description: "Publish even when no changes are detected in packages/core or packages/plugin"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - stable

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      PKG_DIR: packages/plugin
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"

      - name: Install workspace dependencies
        run: npm install --workspaces --include-workspace-root

      - name: Detect extension changes
        id: extension_changes
        shell: bash
        run: |
          set -euo pipefail

          CHANGED_FILES=""

          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            BEFORE="${{ github.event.before }}"
            if [[ -n "${BEFORE}" && "${BEFORE}" != "0000000000000000000000000000000000000000" ]]; then
              CHANGED_FILES="$(git diff --name-only "${BEFORE}" "${GITHUB_SHA}" -- packages/core packages/plugin)"
            else
              CHANGED_FILES="$(git show --name-only --pretty="" "${GITHUB_SHA}" -- packages/core packages/plugin)"
            fi
          else
            if git rev-parse "${GITHUB_SHA}^" >/dev/null 2>&1; then
              CHANGED_FILES="$(git diff --name-only "${GITHUB_SHA}^" "${GITHUB_SHA}" -- packages/core packages/plugin)"
            else
              CHANGED_FILES="$(git show --name-only --pretty="" "${GITHUB_SHA}" -- packages/core packages/plugin)"
            fi
          fi

          if [[ -n "${CHANGED_FILES}" ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Extension changes detected."
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No extension changes detected."
          fi

      - name: Resolve npm publish version
        id: npm_check
        shell: bash
        run: |
          PKG_NAME=$(node -p "require('./' + '${PKG_DIR}' + '/package.json').name")
          PKG_VERSION=$(node -p "require('./' + '${PKG_DIR}' + '/package.json').version")
          FORCE_PUBLISH="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_publish || 'false' }}"
          SHOULD_PUBLISH=false

          if [[ "${{ steps.extension_changes.outputs.has_changes }}" != "true" && "${FORCE_PUBLISH}" != "true" ]]; then
            echo "should_publish=${SHOULD_PUBLISH}" >> "$GITHUB_OUTPUT"
            echo "name=${PKG_NAME}" >> "$GITHUB_OUTPUT"
            echo "version=${PKG_VERSION}" >> "$GITHUB_OUTPUT"
            echo "Skipping publish. No changes under packages/core or packages/plugin."
            exit 0
          fi

          SHOULD_PUBLISH=true
          if [[ "${FORCE_PUBLISH}" == "true" ]]; then
            echo "force_publish=true (manual override via workflow_dispatch input)"
          fi

          version_exists() {
            npm view "${PKG_NAME}@${1}" version >/dev/null 2>&1
          }

          if version_exists "${PKG_VERSION}"; then
            SHOULD_PUBLISH=false
            echo "Package already published: ${PKG_NAME}@${PKG_VERSION} (skipping)"
          else
            echo "Package version available: ${PKG_NAME}@${PKG_VERSION}"
          fi

          echo "name=${PKG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${PKG_VERSION}" >> "$GITHUB_OUTPUT"
          echo "should_publish=${SHOULD_PUBLISH}" >> "$GITHUB_OUTPUT"

      - run: npm run build --prefix packages/core
        if: steps.npm_check.outputs.should_publish == 'true'

      - run: npm run build --prefix "${PKG_DIR}"
        if: steps.npm_check.outputs.should_publish == 'true'

      - name: Stage bundled core dependency into plugin
        if: steps.npm_check.outputs.should_publish == 'true'
        run: |
          CORE_TGZ="$(npm pack --pack-destination /tmp ./packages/core | tail -n 1)"
          npm install --prefix "${PKG_DIR}" --no-save "/tmp/${CORE_TGZ}"

      - name: Validate npm tarball contents
        if: steps.npm_check.outputs.should_publish == 'true'
        run: |
          cd "${PKG_DIR}"
          npm pack --dry-run --json > /tmp/npm-pack.json
          node -e "const fs=require('fs');const out=JSON.parse(fs.readFileSync('/tmp/npm-pack.json','utf8'));const files=out[0]?.files?.map(f=>f.path)||[];if(!files.includes('dist/index.js')){console.error('dist/index.js missing from npm pack output');process.exit(1);}const hasBundledCore=files.some(f=>f.startsWith('node_modules/@getfoundry/unbrowse-core/'));if(!hasBundledCore){console.error('bundled @getfoundry/unbrowse-core missing from npm pack output');process.exit(1);}console.log('npm pack contains dist/index.js and bundled core');"

      - name: Publish package (trusted publishing)
        id: publish_trusted
        if: steps.npm_check.outputs.should_publish == 'true'
        continue-on-error: true
        run: cd "${PKG_DIR}" && npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ""

      - name: Publish package (token fallback)
        if: steps.npm_check.outputs.should_publish == 'true' && steps.publish_trusted.outcome == 'failure'
        run: cd "${PKG_DIR}" && npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Version bumps are intentional: update packages/plugin/package.json in-repo, then push to stable.
