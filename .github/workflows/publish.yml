name: Publish

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    branches:
      - stable
    tags:
      - "v*"

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"

      - name: Resolve npm publish version
        id: npm_check
        shell: bash
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          SHOULD_PUBLISH=true
          BUMPED=false

          version_exists() {
            npm view "${PKG_NAME}@${1}" version >/dev/null 2>&1
          }

          if version_exists "${PKG_VERSION}"; then
            if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == "refs/heads/stable" ]]; then
              while version_exists "${PKG_VERSION}"; do
                npm version patch --no-git-tag-version >/dev/null
                PKG_VERSION=$(node -p "require('./package.json').version")
                BUMPED=true
              done
              echo "Bumped package version to: ${PKG_NAME}@${PKG_VERSION}"
            else
              SHOULD_PUBLISH=false
              echo "Package already published: ${PKG_NAME}@${PKG_VERSION}"
            fi
          else
            echo "Package version available: ${PKG_NAME}@${PKG_VERSION}"
          fi

          echo "name=${PKG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${PKG_VERSION}" >> "$GITHUB_OUTPUT"
          echo "should_publish=${SHOULD_PUBLISH}" >> "$GITHUB_OUTPUT"
          echo "bumped=${BUMPED}" >> "$GITHUB_OUTPUT"

      - run: npm install
        if: steps.npm_check.outputs.should_publish == 'true'

      - run: npm run build
        if: steps.npm_check.outputs.should_publish == 'true'

      - name: Publish package (trusted publishing)
        id: publish_trusted
        if: steps.npm_check.outputs.should_publish == 'true'
        continue-on-error: true
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ""

      - name: Publish package (token fallback)
        if: steps.npm_check.outputs.should_publish == 'true' && steps.publish_trusted.outcome == 'failure'
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Commit bumped version to stable
        if: steps.npm_check.outputs.should_publish == 'true' && steps.npm_check.outputs.bumped == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/stable'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json
          if git diff --cached --quiet; then
            echo "No version changes to commit."
            exit 0
          fi
          git commit -m "chore: bump version to ${{ steps.npm_check.outputs.version }} [skip ci]"
          git push origin HEAD:stable
