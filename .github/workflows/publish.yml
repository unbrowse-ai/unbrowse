name: Publish

on:
  workflow_dispatch:
  push:
    branches:
      - stable

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      PKG_DIR: packages/plugin
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"

      - name: Detect extension changes
        id: extension_changes
        shell: bash
        run: |
          set -euo pipefail

          CHANGED_FILES=""

          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            BEFORE="${{ github.event.before }}"
            if [[ -n "${BEFORE}" && "${BEFORE}" != "0000000000000000000000000000000000000000" ]]; then
              CHANGED_FILES="$(git diff --name-only "${BEFORE}" "${GITHUB_SHA}" -- packages/plugin)"
            else
              CHANGED_FILES="$(git show --name-only --pretty="" "${GITHUB_SHA}" -- packages/plugin)"
            fi
          else
            if git rev-parse "${GITHUB_SHA}^" >/dev/null 2>&1; then
              CHANGED_FILES="$(git diff --name-only "${GITHUB_SHA}^" "${GITHUB_SHA}" -- packages/plugin)"
            else
              CHANGED_FILES="$(git show --name-only --pretty="" "${GITHUB_SHA}" -- packages/plugin)"
            fi
          fi

          if [[ -n "${CHANGED_FILES}" ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Extension changes detected."
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No extension changes detected."
          fi

      - name: Resolve npm publish version
        id: npm_check
        shell: bash
        run: |
          PKG_NAME=$(node -p "require('./' + '${PKG_DIR}' + '/package.json').name")
          PKG_VERSION=$(node -p "require('./' + '${PKG_DIR}' + '/package.json').version")
          SHOULD_PUBLISH=false
          BUMPED=false

          if [[ "${{ steps.extension_changes.outputs.has_changes }}" != "true" ]]; then
            echo "should_publish=${SHOULD_PUBLISH}" >> "$GITHUB_OUTPUT"
            echo "name=${PKG_NAME}" >> "$GITHUB_OUTPUT"
            echo "version=${PKG_VERSION}" >> "$GITHUB_OUTPUT"
            echo "bumped=${BUMPED}" >> "$GITHUB_OUTPUT"
            echo "Skipping publish. No changes under packages/plugin."
            exit 0
          fi

          SHOULD_PUBLISH=true

          version_exists() {
            npm view "${PKG_NAME}@${1}" version >/dev/null 2>&1
          }

          if version_exists "${PKG_VERSION}"; then
            if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == "refs/heads/stable" ]]; then
              while version_exists "${PKG_VERSION}"; do
                pushd "${PKG_DIR}" >/dev/null
                npm version patch --no-git-tag-version >/dev/null
                popd >/dev/null
                PKG_VERSION=$(node -p "require('./' + '${PKG_DIR}' + '/package.json').version")
                BUMPED=true
              done
              echo "Bumped package version to: ${PKG_NAME}@${PKG_VERSION}"
            else
              SHOULD_PUBLISH=false
              echo "Package already published: ${PKG_NAME}@${PKG_VERSION}"
            fi
          else
            echo "Package version available: ${PKG_NAME}@${PKG_VERSION}"
          fi

          if version_exists "${PKG_VERSION}"; then
            SHOULD_PUBLISH=false
            echo "Version is still occupied: ${PKG_NAME}@${PKG_VERSION}"
          fi

          echo "name=${PKG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${PKG_VERSION}" >> "$GITHUB_OUTPUT"
          echo "should_publish=${SHOULD_PUBLISH}" >> "$GITHUB_OUTPUT"
          echo "bumped=${BUMPED}" >> "$GITHUB_OUTPUT"

      - run: npm install --prefix "${PKG_DIR}"
        if: steps.npm_check.outputs.should_publish == 'true'

      - run: npm run build --prefix "${PKG_DIR}"
        if: steps.npm_check.outputs.should_publish == 'true'

      - name: Publish package (trusted publishing)
        id: publish_trusted
        if: steps.npm_check.outputs.should_publish == 'true'
        continue-on-error: true
        run: cd "${PKG_DIR}" && npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ""

      - name: Publish package (token fallback)
        if: steps.npm_check.outputs.should_publish == 'true' && steps.publish_trusted.outcome == 'failure'
        run: cd "${PKG_DIR}" && npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Commit bumped version to stable
        if: steps.npm_check.outputs.should_publish == 'true' && steps.npm_check.outputs.bumped == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/stable'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${PKG_DIR}/package.json"
          if git diff --cached --quiet; then
            echo "No version changes to commit."
            exit 0
          fi
          git commit -m "chore: bump version to ${{ steps.npm_check.outputs.version }} [skip ci]"
          git push origin HEAD:stable
